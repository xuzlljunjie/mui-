<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="icon" href="images/pand/pand.icon" type="image/x-icon" />
		<!--标准mui.css-->
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/mui.picker.min.css" />
	</head>
	<style>
		
			header img{
				width: 9px;
				height: 18px;
				margin-top: 12px;
			}
				.mui-table-view-cell:after {
			    position: absolute;
			    right: 0;
			    bottom: 0;
			    left: 0px;
			    height: 1px;
			    content: '';
			    -webkit-transform: scaleY(.5);
			    transform: scaleY(.5);
			    background-color: #c8c7cc;
			}
			.mui-content>.mui-table-view:first-child{
				margin-top: 0px;
				border-bottom:9px solid #F7F7F7;
				
			}
			.mui-table-view-cell {
				padding: 12px 15px
			}
			.label{
				font-size: 14px;
				color: #333333;
				width: 28%;
				line-height: 26px;
				
			}
			
			.input{
				width: 72%;
				font-size: 12px;
		        margin-top: 5px;
		       text-align: right;
			}
			#mui-input-row{
				border-bottom: 1px solid #DDDDDD;
				height: 46px;
				
			}
			#showCityPicker3{
				border-bottom: 1px solid #DDDDDD;
				height: 46px;
			}
			#addres {
				width:100%;
				
				
			}
			#addres button{
				width:315px;
				height: 40px;
				text-align: center;
				margin-left: 6.5%;
				margin-top: 40px;
				background: linear-gradient(to left,#FF9849 ,#FF413A );
				border-radius: 50px; 
				color: #ffffff;
				border: 0;
			}
			#cityResult3{
				font-size: 12px;
				color: #333333;
				margin-top: 14px;
			} 
			
			.shezhi{
				width: 100%;
				padding-top: 44px;
				text-align: center;
			}
			.shezhi img{
				width: 90px;
				height: 90px;
				margin-top: 30px;
				border-radius: 50%;
			}
			/*.BoxEvaluateContent {
				height: 120px;
			}*/
			
			#txt_EvaluateContent {
				height: 100%;
				/*border: none;*/
				font-size: 13px;
				margin-bottom: 0px;
				padding: 10px;
			}
			#servertime{
				/*border-top:1px solid #DDDDDD;*/
				border-bottom:1px solid #DDDDDD;
			}
			.mui-navigate-right{
				font-size: 14px;
			}
			.right-info-details {
				color: #999999;
				line-height: 1;
				display: inline-block;
				padding: 3px 6px;
				position: absolute;
				top: 50%;
				right: 30px;
				-webkit-transform: translateY(-50%);
				transform: translateY(-50%);
				font-size: 14px;
			}
	</style>
	<body>
		<div id="app">
			<header class="mui-bar mui-bar-nav">
				<a class="mui-icon mui-icon-left-nav mui-pull-left mui-action-back"></a>
				<h1 class="mui-title">设置</h1>
			</header>
			<div class="shezhi">
				<img id="head"  :src="shoplist.shopImg" />
			</div>
				<form class="mui-input-group">
			    <div id="mui-input-row" class="mui-input-row">
			        <label class="label">店铺名称</label>
			        <input id="shopName"  v-model="shoplist.shopName" class="input" type="text"  placeholder="mimi-12345">
			    </div>
			     <div id="mui-input-row" class="mui-input-row">
			        <label class="label">联系电话</label>
			        <input id="shopTel"  v-model="shoplist.shopTel" class="input" type="text"   placeholder="17634861279">
			    </div>
			    <div class="BoxEvaluateContent">
					<textarea id="txt_EvaluateContent" v-text="shoplist.shopDes" class="mui-input-clear" placeholder="请输入您的店铺简介，可详细说明下您的服务~"></textarea>
				</div>
				<div id="servertime" class="mui-table-view-cell">
					<a class="mui-navigate-right">服务时间</a>
					<span id="certificate" v-text="shoplist.shopTime" class='right-info-details'>全天候</span>
				</div>
			    </div>
			    <div id="addres">
			    	 <button id="loginout">发布</button>
			    </div> 
		   </form>
	  </div>
	</body>
	<script src="../../js/jquery.min.js"></script>
	<script src="../../js/vue.min.js"></script>
    <script src="../../js/mui.js"></script>
	<script src="../../js/mui.picker.min.js"></script>
	<script src="../../js/mui.poppicker.js"></script>
	<script type="text/javascript" src="../../js/city.data.js"></script>
	<script src="../../js/app.js"></script>
	<script src="../../js/config.js"></script>
	<script type="text/javascript">
//		mui.init();
		mui.init({
		    beforeback: function() {
		　　　　 //获得父页面的webview
		        var list = plus.webview.currentWebview().opener();
		　　　　 //触发父页面的自定义事件(refresh),从而进行刷新
		        mui.fire(list, 'refresh');
		        //返回true,继续页面关闭逻辑
		        return true;
		    }
		});
		var vm=new Vue({
			el: '#app',
			data: {
				shoplist: {},   //店铺信息
				imgurl:'',    //图片路径
				shopTimeview: "",  //店铺服务时间段
				shopid:"",    //店铺id
			},
			mounted: function(){
				this.$nextTick(function(){
					var _this = this;
					mui.plusReady(function(){
						_this.InitPage();
						
					})
				})
			},
			methods: {
				InitPage: function(){
					 var _this = this;
					 var sData = plus.webview.currentWebview();
                       	_this.shopid=sData.shopid;
                   var params = {
						token:JSON.parse(localStorage.getItem('token')).accessToken,  //用户token
					    pandUserId:JSON.parse(localStorage.getItem('userinfo')).id,   //用户id	   
				    };
				    mui.ajax({
					    url: CONFIG.basePath+ '/api/pandwork/shop_detail',
						async: false,
						data: params,
						dataType: "json",
						type: 'post',
					    success: function(res){
							console.log('编辑查看店铺详情'+JSON.stringify(res.data));
							_this.shoplist=res.data;
							_this.imgurl=res.data.shopImg;
						},
						error: function(xhr, type, errorThrown){
						   mui.toast('服务器响应失败');
					    }
				    });
					
				},
				
				
			}
		});
		//更换头像
		mui(".shezhi").on("tap", "#head", function(e) {
			if(mui.os.plus){
				var a = [{
					title: "拍照"
				}, {
					title: "从手机相册选择"
				}];
				plus.nativeUI.actionSheet({
					title: "修改头像",
					cancel: "取消",
					buttons: a
				}, function(b) {
					switch (b.index) {
						case 0:
							break;
						case 1:
							appendByCamera();
							break;
						case 2:
							appendByGallery();
							break;
						default:
							break
					}
				})	
			}
			
		});
		 // 拍照添加文件
            function appendByCamera(){
                plus.camera.getCamera().captureImage(function(e){
                    console.log(e);
                    plus.io.resolveLocalFileSystemURL(e, function(entry) { 
                    var path = entry.toLocalURL(); 
                    document.getElementById("head").src = path; 
                    compressImage(path);   //上传文件路径
                    }, function(e) { 
                        mui.toast("读取拍照文件错误：" + e.message); 
                    }); 
    
                });    
            }
            function compressImage(path){
            	
								plus.zip.compressImage({
										src:path,
										dst:"_doc/a.jpg",
										quality:20,
										overwrite:true,
									},
									function(e) {
										//alert("Compress success!");
										upload(e.target)
									},function(error) {
										alert("Compress error!");
								});
							}
            // 从相册添加文件
            function appendByGallery(){
                plus.gallery.pick(function(path){
                    document.getElementById("head").src = path; 
                    upload(path);   //上传文件路径
                });
            }
            //服务端接口路径
            var server = CONFIG.basePath+ '/api/pand_image_upload/image_upload';
            // 上传文件
            function upload(imgurl){
                console.log(imgurl);
               var task=plus.uploader.createUpload(server,
                    {method:"POST"},
                    function(t,status){ //上传完成
                    	console.log(status)
                        if(status==200){
                            console.log("上传成功："+JSON.parse(t.responseText).data);
                            vm.imgurl=JSON.parse(t.responseText).data;
                            //wt.close(); //关闭等待提示按钮
                        }else{
                            alert("上传失败："+status);
                            //wt.close();//关闭等待提示按钮
                        }
                    }
                );
                //添加其他参数
                task.addData("token",JSON.parse(localStorage.getItem('token')).accessToken);
                task.addData("imgModel", "1");
                task.addFile(imgurl,{key:"file"});
                task.start();
                
          }
        //选择证件类型
	    document.getElementById("servertime").addEventListener("tap", function() {
			var picker = new mui.PopPicker();
			picker.setData([{
				value: "1",
			    text: "全天候"
			},{
				value: "2",
			    text: "上午"
			},{
				value: "3",
			    text: "下午"
			},{
			    value:"4",
			    text:"晚上",
			}])
			picker.show(function(rs) {
//							alert(rs[0].value)
			vm.shopTimeview=rs[0].text;
			$("#certificate").html(rs[0].text);
			})
	}, false);
	 document.getElementById('loginout').addEventListener('tap', function() {
		  var params = {
			    token:JSON.parse(localStorage.getItem('token')).accessToken,  //用户token
			    pandUserId:JSON.parse(localStorage.getItem('userinfo')).id,   //用户id
			    id:vm.shopid,   //店铺id
			    shopName:document.getElementById('shopName').value,  //店铺名称
			    shopTel:document.getElementById('shopTel').value,   //联系电话
			    shopDes:document.getElementById('txt_EvaluateContent').value,   //店铺描述
			    shopTime:document.getElementById('certificate').innerText,  //店铺服务时间段
			    shopImg:vm.imgurl,  //店铺头像
		    };
		    mui.ajax({
			    url: CONFIG.basePath+ '/api/pandwork/edit_shop',
				async: false,
				data: params,
				dataType: "json",
				type: 'post',
				success: function(res){
					console.log('店铺编辑成功'+JSON.stringify(res.data));
					localStorage.setItem('shopdetail',JSON.stringify(res.data));
					mui.toast(res.message);
				},
				error: function(xhr, type, errorThrown){
					mui.toast('服务器响应失败');
				}
		    });
	  });
		</script>
</html>
